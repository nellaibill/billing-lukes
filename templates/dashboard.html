<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    {% macro inr(value) %}{{ '{:,.2f}'.format(value) }}{% endmacro %}
    <title>Dashboard</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 2em; background: #f8f9fa; }
        .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 2em 2.5em; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        h1 { margin-bottom: 1em; }
        .summary-boxes { display: flex; gap: 2em; margin-bottom: 2em; }
        .summary-box { background: #f4f4f4; border-radius: 8px; padding: 1.5em 2em; flex: 1; text-align: center; box-shadow: 0 1px 4px rgba(0,0,0,0.05); }
        .summary-title { font-size: 1.1em; color: #555; margin-bottom: 0.5em; }
        .summary-value { font-size: 2em; font-weight: bold; color: #007bff; }
        .section { margin-bottom: 2em; }
        table { border-collapse: collapse; width: 100%; background: #fff; }
        th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
        th { background: #f4f4f4; }
        @media (max-width: 900px) {
            .container { padding: 1em; }
            .summary-boxes { flex-direction: column; gap: 1em; }
        }
    </style>
</head>
<body>
    <div class="container" style="max-width:100vw; padding:32px 40px 32px 48px;">
        {% include '_navbar.html' %}
        <!-- Download Latest Backup Button -->
        <div style="display: flex; justify-content: center; margin: 32px 0 24px 0;">
            <a href="{{ url_for('download_latest_backup') }}" class="card-btn" style="background:#28a745; color:#fff; text-decoration:none; font-size:1.1em; padding:14px 38px; border-radius:30px; box-shadow:0 2px 8px rgba(25,118,210,0.07); font-weight:600;">Download  Backup</a>
        </div>
        <h1>Dashboard</h1>
        <!-- Date Range Picker (daterangepicker) -->
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
        <form method="get" action="{{ url_for('dashboard') }}" id="dashboard-filter-form" style="margin-bottom:2em; display:flex; gap:1em; align-items:center;">
            <input type="text" id="date-range" style="padding:8px; border-radius:4px; border:1px solid #ccc; min-width:220px;" readonly />
            <input type="hidden" name="from_date" id="from_date" value="{{ from_date }}">
            <input type="hidden" name="to_date" id="to_date" value="{{ to_date }}">
            <button type="submit">Filter</button>
        </form>
        <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/moment.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
        <script>
        $(function() {
            var start = moment("{{ from_date }}", "YYYY-MM-DD");
            var end = moment("{{ to_date }}", "YYYY-MM-DD");
            $('#date-range').daterangepicker({
                startDate: start,
                endDate: end,
                locale: { format: 'YYYY-MM-DD' },
                ranges: {
                    'Today': [moment(), moment()],
                    'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                    'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                    'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                    'This Month': [moment().startOf('month'), moment().endOf('month')],
                    'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                }
            }, function(start, end) {
                $('#from_date').val(start.format('YYYY-MM-DD'));
                $('#to_date').val(end.format('YYYY-MM-DD'));
            });
            // Set initial values
            $('#from_date').val(start.format('YYYY-MM-DD'));
            $('#to_date').val(end.format('YYYY-MM-DD'));
            // On submit, ensure hidden fields are set
            $('#dashboard-filter-form').on('submit', function() {
                var drp = $('#date-range').data('daterangepicker');
                $('#from_date').val(drp.startDate.format('YYYY-MM-DD'));
                $('#to_date').val(drp.endDate.format('YYYY-MM-DD'));
            });
        });
        </script>
        <div class="summary-boxes">
            <div class="summary-box">
                <div class="summary-title">Total Bills</div>
                <div class="summary-value">{{ total_bills }}</div>
            </div>
            <div class="summary-box">
                <div class="summary-title">Total Amount</div>
                <div class="summary-value">{{ inr(total_amount) }}</div>
            </div>
            <div class="summary-box">
                <div class="summary-title">Cancelled Bills</div>
                <div class="summary-value">{{ cancelled_bills }}</div>
            </div>
            <div class="summary-box">
                <div class="summary-title">Cancelled Amount</div>
                <div class="summary-value">{{ inr(cancelled_amount) }}</div>
            </div>
        </div>
        <div class="section">
            <h2>Top Categories (by Amount)</h2>
            <table>
                <tr>
                    <th>Category</th>
                    <th style="text-align:right;">Total Amount (₹)</th>
                </tr>
                {% for cat, amt in top_categories %}
                <tr>
                    <td>{{ cat }}</td>
                    <td style="text-align:right;">{{ inr(amt) }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>
        <div class="section">
            <h2>Top Payment Types (by Amount)</h2>
            <div style="display: flex; gap: 1.5em; flex-wrap: wrap;">
                {% for pt, amt in top_payment_types %}
                <div style="background: #e9f7ef; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); padding: 1.2em 2em; min-width: 180px; text-align: center; flex: 1;">
                    <div style="font-size: 1.1em; color: #555; margin-bottom: 0.5em;">{{ pt }}</div>
                    <div style="font-size: 1.7em; font-weight: bold; color: #28a745;">{{ inr(amt) }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        <div class="section">
            <h2>Recent Bills</h2>
            <table>
                <tr>
                    <th>Bill No</th>
                    <th>Name</th>
                    <th>Date</th>
                    <th style="text-align:right;">Total Amount (₹)</th>
                    <th>Status</th>
                </tr>
                {% for bill in recent_bills %}
                <tr>
                    <td>{{ bill.op_bill_no }}</td>
                    <td>{{ bill.patient_name }}</td>
                    <td>{{ bill.date.strftime('%d/%b/%Y') }}</td>
                    <td style="text-align:right;">{{ inr(bill.total_amount) }}</td>
                    <td>{% if bill.is_cancelled %}<span style="color:red;">Cancelled</span>{% else %}Active{% endif %}</td>
                </tr>
                {% endfor %}
            </table>
        </div>
    </div>
</body>
</html>
